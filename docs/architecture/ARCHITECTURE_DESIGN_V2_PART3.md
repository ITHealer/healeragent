# ğŸ—ï¸ HEALERAGENT ARCHITECTURE DESIGN DOCUMENT - PART 3
## Component Specifications & Implementation Details

---

## 10. CONTEXTBUILDER SERVICE (Critical New Component)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONTEXTBUILDER SERVICE SPECIFICATION                             â”‚
â”‚                    (HIGH PRIORITY - Fixes Context Consistency Gap)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         PURPOSE                                              â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  PROBLEM: Currently, context is loaded differently in each phase:           â”‚   â”‚
â”‚  â”‚  â€¢ Intent Classification: loads history but NOT summary                     â”‚   â”‚
â”‚  â”‚  â€¢ Agent Loop: loads summary but unclear on history                         â”‚   â”‚
â”‚  â”‚  â€¢ Direct Response: inconsistent                                            â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  SOLUTION: Single service that loads ALL context ONCE, then provides        â”‚   â”‚
â”‚  â”‚  phase-specific views based on configuration                                â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    COMPONENT DESIGN                                          â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  class ContextBuilder:                                                       â”‚   â”‚
â”‚  â”‚      """                                                                     â”‚   â”‚
â”‚  â”‚      Unified context assembly for all phases.                               â”‚   â”‚
â”‚  â”‚      Loads context ONCE, provides phase-specific views.                     â”‚   â”‚
â”‚  â”‚      """                                                                     â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      # Configuration per phase                                              â”‚   â”‚
â”‚  â”‚      PHASE_CONFIGS = {                                                      â”‚   â”‚
â”‚  â”‚          "intent_classification": ContextConfig(                            â”‚   â”‚
â”‚  â”‚              include_core_memory=True,                                      â”‚   â”‚
â”‚  â”‚              include_summary=True,      # â† NOW INCLUDED                    â”‚   â”‚
â”‚  â”‚              recent_k=3,                # Fast classification               â”‚   â”‚
â”‚  â”‚              include_wm_symbols=True,                                       â”‚   â”‚
â”‚  â”‚          ),                                                                  â”‚   â”‚
â”‚  â”‚          "agent_loop": ContextConfig(                                       â”‚   â”‚
â”‚  â”‚              include_core_memory=True,                                      â”‚   â”‚
â”‚  â”‚              include_summary=True,                                          â”‚   â”‚
â”‚  â”‚              recent_k=5,                # Balanced                          â”‚   â”‚
â”‚  â”‚              include_wm_symbols=True,                                       â”‚   â”‚
â”‚  â”‚              include_tool_descriptions=True,                                â”‚   â”‚
â”‚  â”‚          ),                                                                  â”‚   â”‚
â”‚  â”‚          "direct_response": ContextConfig(                                  â”‚   â”‚
â”‚  â”‚              include_core_memory=True,                                      â”‚   â”‚
â”‚  â”‚              include_summary=True,                                          â”‚   â”‚
â”‚  â”‚              recent_k=5,                                                    â”‚   â”‚
â”‚  â”‚              include_wm_symbols=True,                                       â”‚   â”‚
â”‚  â”‚          ),                                                                  â”‚   â”‚
â”‚  â”‚      }                                                                       â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    DATA STRUCTURES                                           â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  @dataclass                                                                  â”‚   â”‚
â”‚  â”‚  class ContextConfig:                                                        â”‚   â”‚
â”‚  â”‚      include_core_memory: bool = True                                       â”‚   â”‚
â”‚  â”‚      include_summary: bool = True                                           â”‚   â”‚
â”‚  â”‚      recent_k: int = 5                                                      â”‚   â”‚
â”‚  â”‚      include_wm_symbols: bool = True                                        â”‚   â”‚
â”‚  â”‚      include_tool_descriptions: bool = False                                â”‚   â”‚
â”‚  â”‚      max_tokens: int = 100_000                                              â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  @dataclass                                                                  â”‚   â”‚
â”‚  â”‚  class AssembledContext:                                                     â”‚   â”‚
â”‚  â”‚      core_memory: Optional[str] = None                                      â”‚   â”‚
â”‚  â”‚      summary: Optional[str] = None                                          â”‚   â”‚
â”‚  â”‚      recent_messages: List[Dict] = field(default_factory=list)              â”‚   â”‚
â”‚  â”‚      wm_symbols: List[str] = field(default_factory=list)                    â”‚   â”‚
â”‚  â”‚      total_tokens: int = 0                                                  â”‚   â”‚
â”‚  â”‚      was_compacted: bool = False                                            â”‚   â”‚
â”‚  â”‚      loaded_at: datetime = field(default_factory=datetime.utcnow)           â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      def to_system_prompt(self, base_prompt: str) -> str:                   â”‚   â”‚
â”‚  â”‚          """Build system prompt with all context injected."""               â”‚   â”‚
â”‚  â”‚          parts = [base_prompt]                                              â”‚   â”‚
â”‚  â”‚          if self.core_memory:                                               â”‚   â”‚
â”‚  â”‚              parts.append(f"<USER_PROFILE>{self.core_memory}</USER_PROFILE>")â”‚   â”‚
â”‚  â”‚          if self.summary:                                                   â”‚   â”‚
â”‚  â”‚              parts.append(f"<CONVERSATION_SUMMARY>{self.summary}")          â”‚   â”‚
â”‚  â”‚              parts.append("</CONVERSATION_SUMMARY>")                        â”‚   â”‚
â”‚  â”‚          if self.wm_symbols:                                                â”‚   â”‚
â”‚  â”‚              parts.append(f"<SYMBOLS_HINT>{self.wm_symbols}</SYMBOLS_HINT>")â”‚   â”‚
â”‚  â”‚          return "\n".join(parts)                                            â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. INTENT CLASSIFIER SPECIFICATION

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INTENT CLASSIFIER SPECIFICATION                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    INPUT/OUTPUT CONTRACT                                     â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  INPUT:                                                                      â”‚   â”‚
â”‚  â”‚  class ClassificationInput:                                                  â”‚   â”‚
â”‚  â”‚      query: str                          # User's question                  â”‚   â”‚
â”‚  â”‚      context: AssembledContext           # From ContextBuilder              â”‚   â”‚
â”‚  â”‚      images: Optional[List[ProcessedImage]] = None                          â”‚   â”‚
â”‚  â”‚      ui_context: Optional[Dict] = None   # Current chart, etc.              â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  OUTPUT:                                                                     â”‚   â”‚
â”‚  â”‚  class IntentResult:                                                         â”‚   â”‚
â”‚  â”‚      # Core classification                                                  â”‚   â”‚
â”‚  â”‚      query_type: QueryType               # Enum                             â”‚   â”‚
â”‚  â”‚      requires_tools: bool                # Route decision                   â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      # Complexity routing                                                   â”‚   â”‚
â”‚  â”‚      complexity: Complexity              # direct/tool/agent                â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      # Symbol handling                                                      â”‚   â”‚
â”‚  â”‚      validated_symbols: List[str]        # Verified symbols                 â”‚   â”‚
â”‚  â”‚      raw_symbols: List[str]              # All detected                     â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      # Language & Response                                                  â”‚   â”‚
â”‚  â”‚      response_language: str              # "vi" or "en"                     â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      # Explainability                                                       â”‚   â”‚
â”‚  â”‚      reasoning: str                      # Why this decision                â”‚   â”‚
â”‚  â”‚      intent_summary: str                 # Brief summary                    â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    QUERY TYPES                                               â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  class QueryType(str, Enum):                                                â”‚   â”‚
â”‚  â”‚      # Financial queries (require tools)                                   â”‚   â”‚
â”‚  â”‚      STOCK_PRICE = "stock_price"            # GiÃ¡ NVDA?                    â”‚   â”‚
â”‚  â”‚      STOCK_ANALYSIS = "stock_analysis"      # PhÃ¢n tÃ­ch NVDA               â”‚   â”‚
â”‚  â”‚      TECHNICAL_ANALYSIS = "technical"       # RSI, MACD cá»§a NVDA           â”‚   â”‚
â”‚  â”‚      FUNDAMENTAL_ANALYSIS = "fundamental"   # PE, EPS cá»§a NVDA             â”‚   â”‚
â”‚  â”‚      COMPARISON = "comparison"              # So sÃ¡nh NVDA vÃ  AMD          â”‚   â”‚
â”‚  â”‚      NEWS = "news"                          # Tin tá»©c NVDA                 â”‚   â”‚
â”‚  â”‚      SCREENER = "screener"                  # Top gainers, losers          â”‚   â”‚
â”‚  â”‚      CRYPTO = "crypto"                      # Bitcoin, ETH                 â”‚   â”‚
â”‚  â”‚      MARKET = "market"                      # Thá»‹ trÆ°á»ng chung             â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      # General queries (no tools needed)                                   â”‚   â”‚
â”‚  â”‚      GREETING = "greeting"                  # Xin chÃ o                     â”‚   â”‚
â”‚  â”‚      HELP = "help"                          # Báº¡n cÃ³ thá»ƒ lÃ m gÃ¬?           â”‚   â”‚
â”‚  â”‚      GENERAL_KNOWLEDGE = "general"          # GDP lÃ  gÃ¬?                   â”‚   â”‚
â”‚  â”‚      CHITCHAT = "chitchat"                  # HÃ´m nay tháº¿ nÃ o?             â”‚   â”‚
â”‚  â”‚      CLARIFICATION = "clarification"        # Ã báº¡n lÃ  gÃ¬?                 â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      # Special queries                                                      â”‚   â”‚
â”‚  â”‚      MEMORY_RECALL = "memory_recall"        # Báº¡n cÃ²n nhá»› X?               â”‚   â”‚
â”‚  â”‚      FOLLOW_UP = "follow_up"                # CÃ²n tin tá»©c thÃ¬ sao?         â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    COMPLEXITY ROUTING                                        â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  class Complexity(str, Enum):                                               â”‚   â”‚
â”‚  â”‚      DIRECT = "direct"          # No tools, direct LLM response            â”‚   â”‚
â”‚  â”‚      TOOL_REQUIRED = "tool"     # 1-2 simple tool calls                    â”‚   â”‚
â”‚  â”‚      AGENT_LOOP = "agent"       # Multiple turns, complex reasoning        â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  COMPLEXITY_MAPPING:                                                        â”‚   â”‚
â”‚  â”‚  Query                         â”‚ Complexity    â”‚ Max Turns                 â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚   â”‚
â”‚  â”‚  "Xin chÃ o"                    â”‚ DIRECT        â”‚ N/A                       â”‚   â”‚
â”‚  â”‚  "GiÃ¡ NVDA"                    â”‚ TOOL_REQUIRED â”‚ 4                         â”‚   â”‚
â”‚  â”‚  "PhÃ¢n tÃ­ch ká»¹ thuáº­t NVDA"     â”‚ TOOL_REQUIRED â”‚ 4                         â”‚   â”‚
â”‚  â”‚  "So sÃ¡nh NVDA, AMD, INTC"     â”‚ AGENT_LOOP    â”‚ 6                         â”‚   â”‚
â”‚  â”‚  "BÃ¡o cÃ¡o Ä‘áº§y Ä‘á»§ vá» NVDA"      â”‚ AGENT_LOOP    â”‚ 10                        â”‚   â”‚
â”‚  â”‚  "Top 10 cá»• phiáº¿u AI tá»‘t nháº¥t" â”‚ AGENT_LOOP    â”‚ 8                         â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. UNIFIED AGENT SPECIFICATION

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UNIFIED AGENT SPECIFICATION                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    AGENT LOOP STATE MACHINE                                  â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚   â”‚
â”‚  â”‚                    â”‚    INITIALIZED      â”‚                                  â”‚   â”‚
â”‚  â”‚                    â”‚                     â”‚                                  â”‚   â”‚
â”‚  â”‚                    â”‚ â€¢ Context loaded    â”‚                                  â”‚   â”‚
â”‚  â”‚                    â”‚ â€¢ Tools registered  â”‚                                  â”‚   â”‚
â”‚  â”‚                    â”‚ â€¢ SSE ready         â”‚                                  â”‚   â”‚
â”‚  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚   â”‚
â”‚  â”‚                               â”‚ run_stream()                                â”‚   â”‚
â”‚  â”‚                               â–¼                                             â”‚   â”‚
â”‚  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚   â”‚
â”‚  â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â–¶â”‚      THINKING       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚   â”‚
â”‚  â”‚           â”‚        â”‚                     â”‚           â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚        â”‚ â€¢ LLM call w/ tools â”‚           â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚        â”‚ â€¢ Parse response    â”‚           â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚                   â”‚                      â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚        â”‚   tool_calls?       â”‚           â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚         empty     â”‚     present          â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚           â”‚       â”‚       â”‚              â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚           â–¼       â”‚       â–¼              â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚  â”‚  RESPONDING â”‚  â”‚  â”‚   ACTING    â”‚     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚  â”‚             â”‚  â”‚  â”‚             â”‚     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚  â”‚ â€¢ Stream    â”‚  â”‚  â”‚ â€¢ Execute   â”‚     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚  â”‚   response  â”‚  â”‚  â”‚   tools in  â”‚     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚  â”‚ â€¢ Done      â”‚  â”‚  â”‚   parallel  â”‚     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚         â”‚         â”‚         â”‚            â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚         â–¼         â”‚         â–¼            â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚  â”‚  FINISHED   â”‚  â”‚  â”‚   LOGGING   â”‚     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚  â”‚             â”‚  â”‚  â”‚             â”‚     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚  â”‚ â€¢ Cleanup   â”‚  â”‚  â”‚ â€¢ Metrics   â”‚     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚  â”‚ â€¢ Save      â”‚  â”‚  â”‚ â€¢ Track     â”‚     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚                   â”‚         â”‚            â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚                   â”‚         â–¼            â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚                   â”‚  â”‚  MEMORIZING â”‚     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚                   â”‚  â”‚             â”‚     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚                   â”‚  â”‚ â€¢ Append to â”‚     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚                   â”‚  â”‚   messages  â”‚     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚                   â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚                   â”‚         â”‚            â”‚                     â”‚   â”‚
â”‚  â”‚           â”‚                   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚   â”‚
â”‚  â”‚           â”‚                   â”‚         (next turn)                        â”‚   â”‚
â”‚  â”‚           â”‚                   â”‚                                            â”‚   â”‚
â”‚  â”‚           â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚   â”‚
â”‚  â”‚           â”‚         â”‚  step < max_steps? â”‚                                â”‚   â”‚
â”‚  â”‚           â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚   â”‚
â”‚  â”‚           â”‚          yes      â”‚      no                                   â”‚   â”‚
â”‚  â”‚           â”‚           â”‚       â”‚       â”‚                                   â”‚   â”‚
â”‚  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚       â–¼                                   â”‚   â”‚
â”‚  â”‚                               â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚   â”‚
â”‚  â”‚                               â”‚  â”‚ MAX_REACHED â”‚                          â”‚   â”‚
â”‚  â”‚                               â”‚  â”‚ Force respondâ”‚                         â”‚   â”‚
â”‚  â”‚                               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚   â”‚
â”‚  â”‚                               â”‚                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    ADAPTIVE MAX TURNS                                        â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  def get_max_turns(complexity: Complexity) -> int:                          â”‚   â”‚
â”‚  â”‚      """Return max turns based on query complexity."""                      â”‚   â”‚
â”‚  â”‚      return {                                                               â”‚   â”‚
â”‚  â”‚          Complexity.DIRECT: 1,        # Should not reach agent             â”‚   â”‚
â”‚  â”‚          Complexity.TOOL_REQUIRED: 4, # Simple queries                     â”‚   â”‚
â”‚  â”‚          Complexity.AGENT_LOOP: 6,    # Standard complex queries           â”‚   â”‚
â”‚  â”‚      }.get(complexity, 6)                                                   â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  # Can be overridden based on query patterns:                               â”‚   â”‚
â”‚  â”‚  QUERY_MAX_TURNS_OVERRIDE = {                                               â”‚   â”‚
â”‚  â”‚      "comparison_3+_symbols": 8,      # NVDA vs AMD vs INTC                â”‚   â”‚
â”‚  â”‚      "full_report": 10,               # Comprehensive analysis             â”‚   â”‚
â”‚  â”‚      "screener_with_analysis": 8,     # Top gainers + analysis             â”‚   â”‚
â”‚  â”‚  }                                                                           â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    SSE EVENT EMISSION                                        â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  class SSEEventEmitter:                                                      â”‚   â”‚
â”‚  â”‚      """Manages SSE event emission with proper formatting."""               â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      async def emit_thinking_start(self):                                   â”‚   â”‚
â”‚  â”‚          await self._emit({                                                 â”‚   â”‚
â”‚  â”‚              "type": "thinking_start",                                      â”‚   â”‚
â”‚  â”‚              "timestamp": datetime.utcnow().isoformat()                     â”‚   â”‚
â”‚  â”‚          })                                                                  â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      async def emit_thinking_step(self, title: str, content: str):          â”‚   â”‚
â”‚  â”‚          await self._emit({                                                 â”‚   â”‚
â”‚  â”‚              "type": "thinking_step",                                       â”‚   â”‚
â”‚  â”‚              "step": {"title": title, "content": content}                   â”‚   â”‚
â”‚  â”‚          })                                                                  â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      async def emit_thinking_end(self, elapsed_ms: int):                    â”‚   â”‚
â”‚  â”‚          await self._emit({                                                 â”‚   â”‚
â”‚  â”‚              "type": "thinking_end",                                        â”‚   â”‚
â”‚  â”‚              "elapsed_ms": elapsed_ms                                       â”‚   â”‚
â”‚  â”‚          })                                                                  â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      async def emit_turn_start(self, turn: int):                            â”‚   â”‚
â”‚  â”‚          await self._emit({                                                 â”‚   â”‚
â”‚  â”‚              "type": "turn_start",                                          â”‚   â”‚
â”‚  â”‚              "turn": turn                                                   â”‚   â”‚
â”‚  â”‚          })                                                                  â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      async def emit_tool_calls(self, tools: List[Dict]):                    â”‚   â”‚
â”‚  â”‚          await self._emit({                                                 â”‚   â”‚
â”‚  â”‚              "type": "tool_calls",                                          â”‚   â”‚
â”‚  â”‚              "tools": [                                                     â”‚   â”‚
â”‚  â”‚                  {"name": t["name"], "args": t["args"]}                     â”‚   â”‚
â”‚  â”‚                  for t in tools                                             â”‚   â”‚
â”‚  â”‚              ]                                                               â”‚   â”‚
â”‚  â”‚          })                                                                  â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      async def emit_tool_results(self, results: List[Dict]):                â”‚   â”‚
â”‚  â”‚          await self._emit({                                                 â”‚   â”‚
â”‚  â”‚              "type": "tool_results",                                        â”‚   â”‚
â”‚  â”‚              "results": [                                                   â”‚   â”‚
â”‚  â”‚                  {                                                          â”‚   â”‚
â”‚  â”‚                      "name": r["name"],                                     â”‚   â”‚
â”‚  â”‚                      "success": r["success"],                               â”‚   â”‚
â”‚  â”‚                      "preview": r.get("preview", "")[:100]                  â”‚   â”‚
â”‚  â”‚                  }                                                          â”‚   â”‚
â”‚  â”‚                  for r in results                                           â”‚   â”‚
â”‚  â”‚              ]                                                               â”‚   â”‚
â”‚  â”‚          })                                                                  â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      async def emit_content_delta(self, content: str):                      â”‚   â”‚
â”‚  â”‚          await self._emit({                                                 â”‚   â”‚
â”‚  â”‚              "type": "content_delta",                                       â”‚   â”‚
â”‚  â”‚              "content": content                                             â”‚   â”‚
â”‚  â”‚          })                                                                  â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      async def emit_done(self, stats: Dict, charts: List[Dict]):            â”‚   â”‚
â”‚  â”‚          await self._emit({                                                 â”‚   â”‚
â”‚  â”‚              "type": "done",                                                â”‚   â”‚
â”‚  â”‚              "data": {                                                      â”‚   â”‚
â”‚  â”‚                  "total_turns": stats["turns"],                             â”‚   â”‚
â”‚  â”‚                  "total_tool_calls": stats["tool_calls"],                   â”‚   â”‚
â”‚  â”‚                  "processing_time_ms": stats["time_ms"],                    â”‚   â”‚
â”‚  â”‚                  "charts": charts                                           â”‚   â”‚
â”‚  â”‚              }                                                               â”‚   â”‚
â”‚  â”‚          })                                                                  â”‚   â”‚
â”‚  â”‚          await self._emit_raw("[DONE]")                                     â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ IMPLEMENTATION CHECKLIST

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IMPLEMENTATION CHECKLIST                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  SPRINT 1: Context Consistency (1 week)                                            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  [ ] Create ContextBuilder class                                                   â”‚
â”‚      [ ] Define ContextConfig dataclass                                            â”‚
â”‚      [ ] Define AssembledContext dataclass                                         â”‚
â”‚      [ ] Implement assemble() method                                               â”‚
â”‚      [ ] Implement parallel loading (_load_core_memory, etc.)                      â”‚
â”‚      [ ] Implement _compact() for overflow                                         â”‚
â”‚  [ ] Create ConversationSummaryService                                             â”‚
â”‚      [ ] Implement RecursiveSummaryManager                                         â”‚
â”‚      [ ] Create summary prompt template                                            â”‚
â”‚      [ ] Add database migration for session_summaries                              â”‚
â”‚  [ ] Update IntentClassifier                                                       â”‚
â”‚      [ ] Accept AssembledContext                                                   â”‚
â”‚      [ ] Include summary in classification prompt                                  â”‚
â”‚  [ ] Update UnifiedAgent                                                           â”‚
â”‚      [ ] Accept AssembledContext                                                   â”‚
â”‚      [ ] Build system prompt from context                                          â”‚
â”‚  [ ] Update Chat API v4                                                            â”‚
â”‚      [ ] Create ContextBuilder at start                                            â”‚
â”‚      [ ] Pass context to all phases                                                â”‚
â”‚  [ ] Add tests                                                                      â”‚
â”‚      [ ] Unit tests for ContextBuilder                                             â”‚
â”‚      [ ] Integration tests for context flow                                        â”‚
â”‚                                                                                     â”‚
â”‚  SPRINT 2: UX Improvements (1 week)                                                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  [ ] Add thinking display events                                                   â”‚
â”‚      [ ] Create SSEEventEmitter class                                              â”‚
â”‚      [ ] Implement emit_thinking_start()                                           â”‚
â”‚      [ ] Implement emit_thinking_step()                                            â”‚
â”‚      [ ] Implement emit_thinking_end()                                             â”‚
â”‚  [ ] Implement SSE cancellation                                                    â”‚
â”‚      [ ] Add request.is_disconnected() checks                                      â”‚
â”‚      [ ] Implement cleanup on disconnect                                           â”‚
â”‚      [ ] Save partial state                                                        â”‚
â”‚  [ ] Add adaptive max turns                                                        â”‚
â”‚      [ ] Implement get_max_turns()                                                 â”‚
â”‚      [ ] Add complexity-based routing                                              â”‚
â”‚  [ ] Frontend updates (if applicable)                                              â”‚
â”‚      [ ] Thinking panel UI                                                         â”‚
â”‚      [ ] "Thought for Xs" display                                                  â”‚
â”‚                                                                                     â”‚
â”‚  SPRINT 3: Stability (1 week)                                                      â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  [ ] Circuit breaker                                                               â”‚
â”‚      [ ] Implement for LLM calls                                                   â”‚
â”‚      [ ] Implement for FMP API                                                     â”‚
â”‚      [ ] Add monitoring                                                            â”‚
â”‚  [ ] Enhanced error handling                                                       â”‚
â”‚      [ ] Graceful degradation for tool failures                                    â”‚
â”‚      [ ] Better error messages                                                     â”‚
â”‚      [ ] Retry logic improvements                                                  â”‚
â”‚  [ ] Performance optimization                                                      â”‚
â”‚      [ ] Review caching strategy                                                   â”‚
â”‚      [ ] Optimize database queries                                                 â”‚
â”‚      [ ] Connection pooling audit                                                  â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Document Version:** 2.0 - Part 3
**Last Updated:** January 2025
**Author:** HealerAgent Architecture Team
