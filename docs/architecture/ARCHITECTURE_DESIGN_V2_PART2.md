# 🏗️ HEALERAGENT ARCHITECTURE DESIGN DOCUMENT - PART 2
## Additional Architecture Details & Implementation Guidelines

---

## 4. TOOL SYSTEM ARCHITECTURE

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         HEALERAGENT TOOL ARCHITECTURE                               │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                         TOOL CLASS HIERARCHY                                 │   │
│  │                                                                              │   │
│  │                       ┌───────────────────────┐                             │   │
│  │                       │    BaseTool (ABC)     │                             │   │
│  │                       │                       │                             │   │
│  │                       │  Attributes:          │                             │   │
│  │                       │  - name: str          │                             │   │
│  │                       │  - description: str   │                             │   │
│  │                       │  - parameters: dict   │                             │   │
│  │                       │  - category: str      │                             │   │
│  │                       │  - timeout: int       │                             │   │
│  │                       │  - cache_ttl: int     │                             │   │
│  │                       │                       │                             │   │
│  │                       │  Methods:             │                             │   │
│  │                       │  + execute(**kwargs)  │                             │   │
│  │                       │  + to_openai_schema() │                             │   │
│  │                       │  + validate_args()    │                             │   │
│  │                       └───────────┬───────────┘                             │   │
│  │                                   │                                          │   │
│  │              ┌────────────────────┼────────────────────┐                    │   │
│  │              │                    │                    │                    │   │
│  │              ▼                    ▼                    ▼                    │   │
│  │  ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐         │   │
│  │  │   APITool         │ │  ComputeTool      │ │   MemoryTool      │         │   │
│  │  │                   │ │                   │ │                   │         │   │
│  │  │ External API      │ │ Local computation │ │ Memory operations │         │   │
│  │  │ calls (FMP,       │ │ (calculations,    │ │ (save/recall      │         │   │
│  │  │ Binance, Tavily)  │ │ formatting)       │ │ information)      │         │   │
│  │  └───────────────────┘ └───────────────────┘ └───────────────────┘         │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                         TOOL REGISTRY (43 Tools)                             │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │ CATEGORY: PRICE (5 tools)                                           │    │   │
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │    │   │
│  │  │ │getStockPrice│ │getStockQuote│ │getHistorical│ │ getIntraday │    │    │   │
│  │  │ │             │ │             │ │   Price     │ │   Prices    │    │    │   │
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │    │   │
│  │  │ ┌─────────────┐                                                     │    │   │
│  │  │ │getPriceChange│                                                    │    │   │
│  │  │ └─────────────┘                                                     │    │   │
│  │  └─────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │ CATEGORY: TECHNICAL (6 tools)                                       │    │   │
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │    │   │
│  │  │ │getTechnical │ │   getRSI    │ │   getMACD   │ │    getSMA   │    │    │   │
│  │  │ │ Indicators  │ │             │ │             │ │             │    │    │   │
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │    │   │
│  │  │ ┌─────────────┐ ┌─────────────┐                                     │    │   │
│  │  │ │    getEMA   │ │   getBands  │                                     │    │   │
│  │  │ └─────────────┘ └─────────────┘                                     │    │   │
│  │  └─────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │ CATEGORY: FUNDAMENTALS (8 tools)                                    │    │   │
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │    │   │
│  │  │ │getBalance   │ │getIncome    │ │getCashFlow  │ │getKeyMetrics│    │    │   │
│  │  │ │   Sheet     │ │ Statement   │ │             │ │             │    │    │   │
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │    │   │
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │    │   │
│  │  │ │getFinancial │ │  getRatios  │ │getEarnings  │ │getDividends │    │    │   │
│  │  │ │   Growth    │ │             │ │             │ │             │    │    │   │
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │    │   │
│  │  └─────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │ CATEGORY: NEWS (3 tools)                                            │    │   │
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                     │    │   │
│  │  │ │getStockNews │ │ getGeneral  │ │  webSearch  │                     │    │   │
│  │  │ │             │ │    News     │ │  (Tavily)   │                     │    │   │
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘                     │    │   │
│  │  └─────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │ CATEGORY: DISCOVERY (4 tools)                                       │    │   │
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │    │   │
│  │  │ │getScreener  │ │getGainers   │ │ getLosers   │ │getMostActive│    │    │   │
│  │  │ │             │ │             │ │             │ │             │    │    │   │
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │    │   │
│  │  └─────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │ CATEGORY: CRYPTO (5 tools)                                          │    │   │
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │    │   │
│  │  │ │getCrypto    │ │getCrypto    │ │getCrypto    │ │getCrypto    │    │    │   │
│  │  │ │   Price     │ │   Quote     │ │ Historical  │ │   News      │    │    │   │
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │    │   │
│  │  │ ┌─────────────┐                                                     │    │   │
│  │  │ │getCrypto    │                                                     │    │   │
│  │  │ │  Markets    │                                                     │    │   │
│  │  │ └─────────────┘                                                     │    │   │
│  │  └─────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │ CATEGORY: MARKET (4 tools)                                          │    │   │
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │    │   │
│  │  │ │getMarket    │ │getSector    │ │getIndex     │ │getEconomic  │    │    │   │
│  │  │ │  Overview   │ │ Performance │ │ Components  │ │ Calendar    │    │    │   │
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │    │   │
│  │  └─────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │ CATEGORY: RISK (3 tools)                                            │    │   │
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                     │    │   │
│  │  │ │calculateVaR │ │getSharpe    │ │getVolatility│                     │    │   │
│  │  │ │             │ │   Ratio     │ │  Analysis   │                     │    │   │
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘                     │    │   │
│  │  └─────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │ CATEGORY: MEMORY (3 tools)                                          │    │   │
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                     │    │   │
│  │  │ │saveToMemory │ │recallMemory │ │searchMemory │                     │    │   │
│  │  │ │             │ │             │ │  (Qdrant)   │                     │    │   │
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘                     │    │   │
│  │  └─────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │ CATEGORY: META (2 tools) - UNIQUE TO HEALERAGENT                    │    │   │
│  │  │ ┌─────────────┐ ┌─────────────┐                                     │    │   │
│  │  │ │ tool_search │ │getCurrentTime│                                    │    │   │
│  │  │ │ (semantic   │ │             │                                     │    │   │
│  │  │ │  discovery) │ │             │                                     │    │   │
│  │  │ └─────────────┘ └─────────────┘                                     │    │   │
│  │  └─────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. MEMORY & CONTEXT MANAGEMENT

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         MEMORY ARCHITECTURE                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                         MEMORY TYPES OVERVIEW                                │   │
│  │                                                                              │   │
│  │  ┌───────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                                                                        │  │   │
│  │  │  ┌─────────────┐                                                      │  │   │
│  │  │  │    CORE     │ ← Long-term, Cross-session                          │  │   │
│  │  │  │   MEMORY    │   User profile, preferences                         │  │   │
│  │  │  │             │   Persists: YAML file                               │  │   │
│  │  │  │ (Semantic)  │   Updates: Rarely (explicit save)                   │  │   │
│  │  │  └─────────────┘                                                      │  │   │
│  │  │        │                                                               │  │   │
│  │  │        ▼                                                               │  │   │
│  │  │  ┌─────────────┐                                                      │  │   │
│  │  │  │  RECURSIVE  │ ← Medium-term, Per-session                          │  │   │
│  │  │  │   SUMMARY   │   Compressed conversation history                   │  │   │
│  │  │  │             │   Persists: PostgreSQL                              │  │   │
│  │  │  │ (Episodic)  │   Updates: Every 10 messages                        │  │   │
│  │  │  └─────────────┘                                                      │  │   │
│  │  │        │                                                               │  │   │
│  │  │        ▼                                                               │  │   │
│  │  │  ┌─────────────┐                                                      │  │   │
│  │  │  │   WORKING   │ ← Short-term, Per-request                           │  │   │
│  │  │  │   MEMORY    │   Current task state, symbols                       │  │   │
│  │  │  │             │   Persists: Redis (session)                         │  │   │
│  │  │  │(Procedural) │   Updates: Every request                            │  │   │
│  │  │  └─────────────┘                                                      │  │   │
│  │  │        │                                                               │  │   │
│  │  │        ▼                                                               │  │   │
│  │  │  ┌─────────────┐                                                      │  │   │
│  │  │  │   RECENT    │ ← Immediate, Last K messages                        │  │   │
│  │  │  │  MESSAGES   │   Raw conversation turns                            │  │   │
│  │  │  │             │   Persists: PostgreSQL                              │  │   │
│  │  │  │ (Episodic)  │   Updates: Every turn                               │  │   │
│  │  │  └─────────────┘                                                      │  │   │
│  │  │                                                                        │  │   │
│  │  └───────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                    CONTEXT ASSEMBLY FOR EACH PHASE                           │   │
│  │                                                                              │   │
│  │  ┌───────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                                                                        │  │   │
│  │  │  Phase                    │ Core  │ Summary │ Recent K │ Working    │  │   │
│  │  │  ─────────────────────────┼───────┼─────────┼──────────┼────────────│  │   │
│  │  │  Intent Classification    │ ✅    │ ✅ NEW  │ K=3      │ ✅ symbols │  │   │
│  │  │  Agent Loop               │ ✅    │ ✅      │ K=5-10   │ ✅         │  │   │
│  │  │  Direct Response          │ ✅    │ ✅      │ K=5      │ ✅         │  │   │
│  │  │  Synthesis                │ ✅    │ ✅      │ K=3      │ ✅         │  │   │
│  │  │                                                                        │  │   │
│  │  │  Key Change: Summary NOW included in all phases                       │  │   │
│  │  │                                                                        │  │   │
│  │  └───────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. STREAMING & SSE ARCHITECTURE

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         SSE STREAMING ARCHITECTURE                                  │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                         SSE EVENT TYPES                                      │   │
│  │                                                                              │   │
│  │  ┌───────────────────────────────────────────────────────────────────────┐  │   │
│  │  │  Event Type         │ Purpose                  │ Data                  │  │   │
│  │  │  ──────────────────┼──────────────────────────┼───────────────────────│  │   │
│  │  │  thinking_start     │ Start thinking timer     │ { timestamp }         │  │   │
│  │  │  thinking_step      │ Show reasoning step      │ { title, content }    │  │   │
│  │  │  thinking_end       │ Stop timer, show elapsed │ { elapsed_ms }        │  │   │
│  │  │  turn_start         │ New agent loop turn      │ { turn: number }      │  │   │
│  │  │  tool_calls         │ Tools being called       │ { tools: [...] }      │  │   │
│  │  │  tool_results       │ Tool execution results   │ { results: [...] }    │  │   │
│  │  │  content_start      │ Begin response stream    │ { }                   │  │   │
│  │  │  content_delta      │ Response chunk           │ { content: string }   │  │   │
│  │  │  content_end        │ End response stream      │ { }                   │  │   │
│  │  │  error              │ Error occurred           │ { message, code }     │  │   │
│  │  │  done               │ Request complete         │ { stats, charts }     │  │   │
│  │  │  heartbeat          │ Keep connection alive    │ { timestamp }         │  │   │
│  │  └───────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                      SSE EVENT TIMELINE                                      │   │
│  │                                                                              │   │
│  │  ┌───────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                                                                        │  │   │
│  │  │  0.0s  ──► thinking_start { timestamp }                               │  │   │
│  │  │        │                                                               │  │   │
│  │  │  0.2s  │─► thinking_step { title: "Analyzing query..." }              │  │   │
│  │  │        │                                                               │  │   │
│  │  │  0.5s  │─► turn_start { turn: 1 }                                     │  │   │
│  │  │        │                                                               │  │   │
│  │  │  1.5s  │─► tool_calls { tools: [getTechnical, getNews] }              │  │   │
│  │  │        │                                                               │  │   │
│  │  │  3.0s  │─► tool_results { results: [{success}, {success}] }           │  │   │
│  │  │        │                                                               │  │   │
│  │  │  3.5s  │─► turn_start { turn: 2 }                                     │  │   │
│  │  │        │                                                               │  │   │
│  │  │  4.5s  │─► thinking_end { elapsed_ms: 4500 }                          │  │   │
│  │  │        │                                                               │  │   │
│  │  │  4.6s  │─► content_start { }                                          │  │   │
│  │  │        │                                                               │  │   │
│  │  │  4.6s+ │─► content_delta { content: "NVDA " }                         │  │   │
│  │  │        │─► content_delta { content: "hiện đang " }                    │  │   │
│  │  │        │─► content_delta { content: "giao dịch..." }                  │  │   │
│  │  │        │   ... (streaming continues)                                   │  │   │
│  │  │        │                                                               │  │   │
│  │  │  8.0s  │─► content_end { }                                            │  │   │
│  │  │        │                                                               │  │   │
│  │  │  8.2s  ──► done { total_turns: 2, tool_calls: 2, charts: [...] }     │  │   │
│  │  │        │                                                               │  │   │
│  │  │        ──► [DONE]                                                     │  │   │
│  │  │                                                                        │  │   │
│  │  └───────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                   THINKING DISPLAY UI (ChatGPT Style)                        │   │
│  │                                                                              │   │
│  │  ┌───────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                                                                        │  │   │
│  │  │  ┌─────────────────────────────────────────────────────────────────┐  │  │   │
│  │  │  │  MAIN CHAT AREA                    │  THINKING PANEL (Right)    │  │  │   │
│  │  │  │                                    │                            │  │  │   │
│  │  │  │  👤 User:                          │  💭 Thinking               │  │  │   │
│  │  │  │  "Phân tích kỹ thuật NVDA"        │                            │  │  │   │
│  │  │  │                                    │  ● Analyzing query...     │  │  │   │
│  │  │  │  ⏱️ Thought for 4.5s ▼            │    User asking for        │  │  │   │
│  │  │  │                                    │    technical analysis     │  │  │   │
│  │  │  │  🤖 Assistant:                     │                            │  │  │   │
│  │  │  │  NVDA hiện đang giao dịch ở mức   │  ● Fetching data...       │  │  │   │
│  │  │  │  $850.25. Phân tích kỹ thuật:     │    Getting RSI, MACD,     │  │  │   │
│  │  │  │                                    │    Bollinger bands        │  │  │   │
│  │  │  │  📊 RSI(14): 65 - Trung tính      │                            │  │  │   │
│  │  │  │  📈 MACD: Bullish crossover       │  ● Synthesizing...        │  │  │   │
│  │  │  │  ...                               │    Combining indicators   │  │  │   │
│  │  │  │                                    │                            │  │  │   │
│  │  │  │                                    │  ⏱️ Thought for 4.5s      │  │  │   │
│  │  │  │                                    │  Done ✓                   │  │  │   │
│  │  │  └─────────────────────────────────────────────────────────────────┘  │  │   │
│  │  │                                                                        │  │   │
│  │  └───────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. SCALE STRATEGY

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           SCALE STRATEGY                                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                    RATE LIMITING STRATEGY                                    │   │
│  │                                                                              │   │
│  │  ┌───────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                                                                        │  │   │
│  │  │  Layer                 │ Limit              │ Window                   │  │   │
│  │  │  ─────────────────────┼────────────────────┼─────────────────────────│  │   │
│  │  │  Per User (Free)       │ 20 requests        │ per hour                │  │   │
│  │  │  Per User (Premium)    │ 100 requests       │ per hour                │  │   │
│  │  │  Per Session           │ 50 requests        │ per hour                │  │   │
│  │  │  Global (System)       │ 1000 requests      │ per minute              │  │   │
│  │  │  LLM API              │ Based on provider  │ -                        │  │   │
│  │  │  FMP API              │ 300 requests       │ per minute              │  │   │
│  │  │                                                                        │  │   │
│  │  │  Implementation: Redis-based sliding window                           │  │   │
│  │  │                                                                        │  │   │
│  │  └───────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                    CACHING STRATEGY                                          │   │
│  │                                                                              │   │
│  │  ┌───────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                                                                        │  │   │
│  │  │  Layer          │ Storage       │ TTL         │ Use Case              │  │   │
│  │  │  ───────────────┼───────────────┼─────────────┼───────────────────────│  │   │
│  │  │  L1: In-Memory  │ Python dict   │ Request     │ Within-request cache │  │   │
│  │  │  L2: Redis      │ Redis         │ Varies      │ Cross-request cache  │  │   │
│  │  │  L3: PostgreSQL │ PostgreSQL    │ Permanent   │ Persistence          │  │   │
│  │  │                                                                        │  │   │
│  │  │  Tool-specific TTLs:                                                  │  │   │
│  │  │  • Price data: 30 seconds                                             │  │   │
│  │  │  • Technical indicators: 5 minutes                                    │  │   │
│  │  │  • Fundamentals: 24 hours                                             │  │   │
│  │  │  • News: 15 minutes                                                   │  │   │
│  │  │  • Company profile: 7 days                                            │  │   │
│  │  │                                                                        │  │   │
│  │  └───────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. ERROR HANDLING & RECOVERY

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      ERROR HANDLING & RECOVERY                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                      ERROR CATEGORIES                                        │   │
│  │                                                                              │   │
│  │  ┌───────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                                                                        │  │   │
│  │  │  Category              │ Examples                │ Recovery Strategy   │  │   │
│  │  │  ─────────────────────┼─────────────────────────┼─────────────────────│  │   │
│  │  │  LLM Errors            │ Rate limit, timeout     │ Retry + fallback    │  │   │
│  │  │  Tool Errors           │ API failure, timeout    │ Graceful degradation│  │   │
│  │  │  Validation Errors     │ Invalid input           │ Return error message│  │   │
│  │  │  System Errors         │ DB down, Redis down     │ Circuit breaker     │  │   │
│  │  │  Client Errors         │ Disconnect, timeout     │ Cleanup + save state│  │   │
│  │  │                                                                        │  │   │
│  │  └───────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                    GRACEFUL DEGRADATION                                      │   │
│  │                                                                              │   │
│  │  ┌───────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                                                                        │  │   │
│  │  │  Tool Failure Handling:                                               │  │   │
│  │  │                                                                        │  │   │
│  │  │  tools_to_execute = [tool1, tool2, tool3, tool4]                     │  │   │
│  │  │                                                                        │  │   │
│  │  │  results = await asyncio.gather(                                      │  │   │
│  │  │      *[execute(t) for t in tools_to_execute],                        │  │   │
│  │  │      return_exceptions=True  ← Catch errors, don't fail all         │  │   │
│  │  │  )                                                                    │  │   │
│  │  │                                                                        │  │   │
│  │  │  successful = [r for r in results if not isinstance(r, Exception)]   │  │   │
│  │  │  failed = [r for r in results if isinstance(r, Exception)]           │  │   │
│  │  │                                                                        │  │   │
│  │  │  if len(successful) > 0:                                              │  │   │
│  │  │      # Continue with available data                                   │  │   │
│  │  │      # Inform user about partial results                              │  │   │
│  │  │  else:                                                                 │  │   │
│  │  │      # All tools failed, return error                                 │  │   │
│  │  │                                                                        │  │   │
│  │  └───────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                    CIRCUIT BREAKER PATTERN                                   │   │
│  │                                                                              │   │
│  │  ┌───────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                                                                        │  │   │
│  │  │  Service Health Check:                                                │  │   │
│  │  │                                                                        │  │   │
│  │  │  ┌─────────┐    5 failures    ┌─────────┐    30s timeout   ┌───────┐ │  │   │
│  │  │  │ CLOSED  │ ───────────────▶ │  OPEN   │ ────────────────▶│ HALF- │ │  │   │
│  │  │  │         │                  │         │                  │ OPEN  │ │  │   │
│  │  │  └─────────┘                  └─────────┘                  └───────┘ │  │   │
│  │  │       ▲                                                        │      │  │   │
│  │  │       │                        success                         │      │  │   │
│  │  │       └────────────────────────────────────────────────────────┘      │  │   │
│  │  │                                                                        │  │   │
│  │  │  Applied to:                                                          │  │   │
│  │  │  • LLM API calls                                                      │  │   │
│  │  │  • FMP/Binance API calls                                             │  │   │
│  │  │  • Database connections                                               │  │   │
│  │  │                                                                        │  │   │
│  │  └───────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. MONITORING & OBSERVABILITY

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      MONITORING & OBSERVABILITY                                     │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                         KEY METRICS                                          │   │
│  │                                                                              │   │
│  │  ┌───────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                                                                        │  │   │
│  │  │  Category           │ Metrics                                          │  │   │
│  │  │  ──────────────────┼──────────────────────────────────────────────────│  │   │
│  │  │  Request           │ • requests_total (counter)                        │  │   │
│  │  │                    │ • request_duration_seconds (histogram)            │  │   │
│  │  │                    │ • active_requests (gauge)                         │  │   │
│  │  │                    │                                                    │  │   │
│  │  │  Agent             │ • agent_turns_total (counter)                     │  │   │
│  │  │                    │ • agent_turn_duration_seconds (histogram)         │  │   │
│  │  │                    │ • max_turns_reached_total (counter)               │  │   │
│  │  │                    │                                                    │  │   │
│  │  │  Tools             │ • tool_calls_total (counter by tool_name)         │  │   │
│  │  │                    │ • tool_duration_seconds (histogram by tool)       │  │   │
│  │  │                    │ • tool_errors_total (counter by tool)             │  │   │
│  │  │                    │ • tool_cache_hits (counter)                       │  │   │
│  │  │                    │                                                    │  │   │
│  │  │  LLM               │ • llm_calls_total (counter by model)              │  │   │
│  │  │                    │ • llm_tokens_used (counter: input, output)        │  │   │
│  │  │                    │ • llm_duration_seconds (histogram)                │  │   │
│  │  │                    │ • llm_errors_total (counter)                      │  │   │
│  │  │                    │                                                    │  │   │
│  │  │  Memory            │ • context_tokens_total (gauge)                    │  │   │
│  │  │                    │ • compaction_runs_total (counter)                 │  │   │
│  │  │                    │ • compaction_tokens_saved (counter)               │  │   │
│  │  │                    │                                                    │  │   │
│  │  └───────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 📋 IMPLEMENTATION PRIORITY

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      IMPLEMENTATION PRIORITY ROADMAP                                │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  Sprint 1 (1 week): CONTEXT CONSISTENCY                                            │
│  ═══════════════════════════════════════════════════════════════════════════════   │
│  [ ] Implement ContextBuilder service                                              │
│  [ ] Load summary BEFORE Phase 2 (Intent Classification)                           │
│  [ ] Pass summary + recent_k to all phases                                         │
│  [ ] Test context consistency across phases                                        │
│                                                                                     │
│  Sprint 2 (1 week): UX IMPROVEMENTS                                                │
│  ═══════════════════════════════════════════════════════════════════════════════   │
│  [ ] Add thinking_start/end SSE events                                             │
│  [ ] Add thinking_step events during agent loop                                    │
│  [ ] Implement SSE cancellation handling                                           │
│  [ ] Frontend: Thinking panel UI                                                   │
│                                                                                     │
│  Sprint 3 (1 week): STABILITY & PERFORMANCE                                        │
│  ═══════════════════════════════════════════════════════════════════════════════   │
│  [ ] Adaptive max_turns based on complexity                                        │
│  [ ] Circuit breaker for LLM/API calls                                             │
│  [ ] Enhanced error handling and recovery                                          │
│  [ ] Performance optimization (caching, pooling)                                   │
│                                                                                     │
│  Sprint 4+ (Future): ADVANCED FEATURES                                             │
│  ═══════════════════════════════════════════════════════════════════════════════   │
│  [ ] Memory search tools (conversation_search, recent_chats)                       │
│  [ ] Sandbox for code execution (if needed)                                        │
│  [ ] MCP protocol support                                                          │
│  [ ] Deep research multi-agent mode                                                │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

**Document Version:** 2.0 - Part 2
**Last Updated:** January 2025
**Author:** HealerAgent Architecture Team
